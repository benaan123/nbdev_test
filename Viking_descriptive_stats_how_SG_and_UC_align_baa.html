<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nbdev_test â€“ viking_descriptive_stats_how_sg_and_uc_align_baa</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">nbdev_test</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/benaan123/nbdev_test"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">(Untitled)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">nbdev_test</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">core</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Viking_descriptive_stats_how_SG_and_UC_align_baa.html" class="sidebar-item-text sidebar-link active">The aim of this notebook</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<div class="cell" data-outputid="7cfa67d0-9824-4b92-982d-d68377c6bb7c">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title &lt;-- Press Play to trigger setup { run: "auto", display-mode: "form" }</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#@markdown - Autenticates user, initialises BigQuery `client`</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#@markdown - Sets default `--project` to `PROJECT_ID` and adds  `--no_df` and `--param` flags to `%%bigquery`</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#@markdown - Ask for user  confirmation before executing queries that will cost more than `COST_LIMIT_USD`, unless `--cost_approved` flag is specified</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.cloud <span class="im">import</span> bigquery</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cartoframes.viz <span class="im">import</span> Map, Layer, color_continuous_style, basic_style</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> difflib</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> bigquery.Client(project<span class="op">=</span><span class="st">'uc-prox-core-dev'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">#!pip install plotly==4.8</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Quick way to install hind font</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>npm install <span class="op">-</span>g npm</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>npm install <span class="op">-</span>g google<span class="op">-</span>font<span class="op">-</span>installer</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>gfi install hind <span class="op">-</span>v <span class="dv">300</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objs <span class="im">as</span> go</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.io <span class="im">as</span> pio</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.offline <span class="im">as</span> py</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ipywidgets <span class="im">as</span> widgets</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipywidgets <span class="im">import</span> interact, interact_manual</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> IPython.display</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, clear_output</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">#define colors for printing</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> color:</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>   PURPLE <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[95m'</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>   CYAN <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[96m'</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>   DARKCYAN <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[36m'</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>   BLUE <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[94m'</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>   GREEN <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[92m'</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>   YELLOW <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[93m'</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>   RED <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[91m'</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>   BOLD <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[1m'</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>   UNDERLINE <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[4m'</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>   END <span class="op">=</span> <span class="st">'</span><span class="ch">\033</span><span class="st">[0m'</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>pd.options.plotting.backend <span class="op">=</span> <span class="st">"plotly"</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># create unacast template (corporate design)</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>pio.templates[<span class="st">'unacast'</span>] <span class="op">=</span> go.layout.Template({</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'data'</span>: {<span class="st">'scatter'</span>: [{<span class="st">'marker'</span>: {<span class="st">'size'</span>: <span class="dv">20</span>, <span class="st">'symbol'</span>: <span class="st">'hexagon'</span>}, <span class="st">'type'</span>: <span class="st">'scatter'</span>}]},</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'layout'</span>: {<span class="st">'autosize'</span>: <span class="va">True</span>,</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>               <span class="st">'colorscale'</span>: {<span class="st">'diverging'</span>: [[<span class="dv">0</span>, <span class="st">'#8e0152'</span>], [<span class="fl">0.1</span>, <span class="st">'#c51b7d'</span>],</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                                            [<span class="fl">0.2</span>, <span class="st">'#de77ae'</span>], [<span class="fl">0.3</span>, <span class="st">'#f1b6da'</span>],</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>                                            [<span class="fl">0.4</span>, <span class="st">'#fde0ef'</span>], [<span class="fl">0.5</span>, <span class="st">'#f7f7f7'</span>],</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>                                            [<span class="fl">0.6</span>, <span class="st">'#e6f5d0'</span>], [<span class="fl">0.7</span>, <span class="st">'#b8e186'</span>],</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>                                            [<span class="fl">0.8</span>, <span class="st">'#7fbc41'</span>], [<span class="fl">0.9</span>, <span class="st">'#4d9221'</span>], [<span class="dv">1</span>,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">'#276419'</span>]],</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'sequential'</span>: [[<span class="fl">0.0</span>, <span class="st">'#0d0887'</span>],</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.1111111111111111</span>, <span class="st">'#46039f'</span>],</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.2222222222222222</span>, <span class="st">'#7201a8'</span>],</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.3333333333333333</span>, <span class="st">'#9c179e'</span>],</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.4444444444444444</span>, <span class="st">'#bd3786'</span>],</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.5555555555555556</span>, <span class="st">'#d8576b'</span>],</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.6666666666666666</span>, <span class="st">'#ed7953'</span>],</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.7777777777777778</span>, <span class="st">'#fb9f3a'</span>],</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                                             [<span class="fl">0.8888888888888888</span>, <span class="st">'#fdca26'</span>], [<span class="fl">1.0</span>,</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">'#f0f921'</span>]],</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>                              <span class="st">'sequentialminus'</span>: [[<span class="fl">0.0</span>, <span class="st">'#0d0887'</span>],</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.1111111111111111</span>, <span class="st">'#46039f'</span>],</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.2222222222222222</span>, <span class="st">'#7201a8'</span>],</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.3333333333333333</span>, <span class="st">'#9c179e'</span>],</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.4444444444444444</span>, <span class="st">'#bd3786'</span>],</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.5555555555555556</span>, <span class="st">'#d8576b'</span>],</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.6666666666666666</span>, <span class="st">'#ed7953'</span>],</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.7777777777777778</span>, <span class="st">'#fb9f3a'</span>],</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">0.8888888888888888</span>, <span class="st">'#fdca26'</span>],</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>                                                  [<span class="fl">1.0</span>, <span class="st">'#f0f921'</span>]]},</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>               <span class="st">'colorway'</span>: [<span class="st">'#FF8000'</span>, <span class="st">'#1A4D60'</span>, <span class="st">'#00B39B'</span>, <span class="st">'#34768F'</span>, <span class="st">'#C42240'</span>,</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'#C42240'</span>, <span class="st">'#404040'</span>], <span class="co"># removed , '#F6F6F6' for better plotting (white)</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>               <span class="st">'font'</span>: {<span class="st">'color'</span>: <span class="st">'#1C1C1C'</span>, <span class="st">'family'</span>: <span class="st">'Hind'</span>},</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>               <span class="st">'hoverlabel'</span>: {<span class="st">'align'</span>: <span class="st">'left'</span>},</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>               <span class="st">'height'</span>: <span class="dv">600</span>,</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>               <span class="st">'width'</span>: <span class="dv">1400</span>,</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>               <span class="st">'images'</span>: [{<span class="st">'sizex'</span>: <span class="fl">0.3</span>,</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'sizey'</span>: <span class="fl">0.3</span>,</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'source'</span>: (<span class="st">'https://proptechzone.com/wp-content/uploads/2019/10/unacast-3b04492b-4fe9-4b70-9dc7-43fb22aa6d5c-1.png'</span>),</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>                           <span class="co">#'source': "https://global-uploads.webflow.com/5dc3e2af6a906d9cc232e1bc/5dc3e2af6a906dceb532e551_unacast-symbol-uc_orange-rgb.png",</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'x'</span>: <span class="fl">0.96</span>,</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'xanchor'</span>: <span class="st">'center'</span>,</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'xref'</span>: <span class="st">'paper'</span>,</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'y'</span>: <span class="fl">0.9</span>,</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'yanchor'</span>: <span class="st">'bottom'</span>,</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'yref'</span>: <span class="st">'paper'</span>,</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'name'</span>: <span class="st">'uc-logo'</span>}],</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>               <span class="st">'margin'</span>: {<span class="st">'b'</span>: <span class="dv">60</span>, <span class="st">'l'</span>: <span class="dv">60</span>, <span class="st">'r'</span>: <span class="dv">60</span>, <span class="st">'t'</span>: <span class="dv">60</span>},</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>               <span class="st">'paper_bgcolor'</span>: <span class="st">'#FFFFFF'</span>,</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>               <span class="st">'plot_bgcolor'</span>: <span class="st">'#F5F6F7'</span>,</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>               <span class="st">'title'</span>: {<span class="st">'font'</span>: {<span class="st">'size'</span>: <span class="dv">25</span>}},</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>              <span class="st">'xaxis'</span>: {<span class="st">'automargin'</span>: <span class="va">True</span>,</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'gridcolor'</span>: <span class="st">'white'</span>,</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'linecolor'</span>: <span class="st">'white'</span>,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'showgrid'</span>: <span class="va">True</span>,</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'tickcolor'</span>: <span class="st">'rgb(51,51,51)'</span>,</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'ticks'</span>: <span class="st">'outside'</span>,</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'title'</span>: {<span class="st">'standoff'</span>: <span class="dv">15</span>},</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'zerolinecolor'</span>: <span class="st">'white'</span>},</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>               <span class="st">'yaxis'</span>: {<span class="st">'automargin'</span>: <span class="va">True</span>,</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'gridcolor'</span>: <span class="st">'white'</span>,</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'linecolor'</span>: <span class="st">'white'</span>,</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'showgrid'</span>: <span class="va">True</span>,</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'tickcolor'</span>: <span class="st">'rgb(51,51,51)'</span>,</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'ticks'</span>: <span class="st">'outside'</span>,</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'title'</span>: {<span class="st">'standoff'</span>: <span class="dv">15</span>},</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'zerolinecolor'</span>: <span class="st">'white'</span>}}</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Print success message</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Ran at"</span>, datetime.now(), <span class="st">"GMT"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cartoframes.viz <span class="im">import</span> Map, Layer, color_continuous_style</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">"once"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#The aim of this notebook is to compare SafeGraph and Unacast patterns to show where those versions align and where they differ. This should be used to track process for key industries as well.</p>
<p>Reproducibility given by consistent analysis: - restrict to target industries: (â€˜722511â€™,â€˜722513â€™,â€˜444130â€™,â€˜445110â€™,â€˜445120â€™,â€˜447110â€™,â€˜452319â€™,â€˜517312â€™,â€˜713990â€™,â€˜721110â€™,â€˜721120â€™,â€˜722515â€™) - restrict to 2021-01-01 to 2021-03-31 - region: Chicago + Dallas - for trimmed mean remove top and low 0.01 quantile - percentage of places above .55 correlation used</p>
<p>#Todo:</p>
<ul>
<li>spider plot:
<ul>
<li>run grand summary per naics code</li>
<li>adjust radar plot to use that output</li>
<li>add more metrixs (percent of placekey with sign. drop)</li>
</ul></li>
<li>how many NaN and 0 (what are we dropping)</li>
</ul>
<div class="cell" data-cellview="form">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title Input tables and filters</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>SG_table <span class="op">=</span> <span class="st">"uc-prox-core-dev.viking_input.combined_weekly_patterns"</span> <span class="co">#@param {type: "string"}</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>UC_table <span class="op">=</span> <span class="st">"uc-prox-core-dev.viking_align_v1_patterns.patterns_final_view_weekly"</span> <span class="co">#@param {type: "string"}</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>PLACES_table <span class="op">=</span> <span class="st">"uc-prox-core-dev.viking_input.combined_places"</span> <span class="co">#@param{type: "string"}</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#@markdown restrict to specific industries or in time:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>industries <span class="op">=</span> <span class="st">"('722511','722513','444130','445110','445120','447110','452319','517312','713990','721110','721120','722515')"</span> <span class="co">#@param {type: "string"}</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2021-01-01"</span> <span class="co">#@param{type: "string"}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2021-03-31"</span> <span class="co">#@param{type: "string"}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-cellview="form">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title define queries</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>base_sql <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ss">WITH</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ss">  base AS (</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ss">  SELECT</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ss">    pat.*,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="ss">    top_category,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ss">    sub_category,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ss">    naics_code</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ss">  FROM</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ss">    `</span><span class="sc">{</span>SG_table<span class="sc">}</span><span class="ss">` pat</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  LEFT JOIN</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="ss">    `</span><span class="sc">{</span>PLACES_table<span class="sc">}</span><span class="ss">`</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="ss">  USING</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="ss">    (placekey)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="ss">  WHERE date(date_range_start) between date("</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">") and date("</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">") ),</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="ss">  join_sg_uc AS (</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="ss">  SELECT</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.placekey,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.location_name,</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    case when sg.brands = "" or sg.brands is null then "NN" else sg.brands END brands,</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.region,</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.wkt_area_sq_meters,</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.parent_placekey,</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.date_range_start,</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.date_range_end,</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.top_category,</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.sub_category,</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="ss">    naics_code || "_" || sub_category naics_code,</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.raw_visit_counts sg_raw_visit_counts,</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.raw_visit_counts uc_raw_visit_counts,</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.raw_visitor_counts sg_raw_visitor_counts,</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.raw_visitor_counts uc_raw_visitor_counts,</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.visitor_home_cbgs sg_visitor_home_cbgs,</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.visitor_home_cbgs uc_visitor_home_cbgs,</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.distance_from_home sg_distance_from_home,</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.distance_from_home uc_distance_from_home,</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.median_dwell sg_median_dwell,</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.median_dwell uc_median_dwell,</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.normalized_visits_by_state_scaling sg_normalized_visits_by_state_scaling,</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.normalized_visits_by_state_scaling uc_normalized_visits_by_state_scaling,</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.normalized_visits_by_total_visits sg_normalized_visits_by_total_visits,</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.normalized_visits_by_total_visits uc_normalized_visits_by_total_visits,</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.normalized_visits_by_total_visitors sg_normalized_visits_by_total_visitors,</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.normalized_visits_by_total_visitors uc_normalized_visits_by_total_visitors,</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.normalized_visits_by_region_naics_visits sg_normalized_visits_by_region_naics_visits,</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="ss">    uc.normalized_visits_by_region_naics_visits uc_normalized_visits_by_region_naics_visits,</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="ss">    --sg.normalized_visitors_by_region_naics_visits sg_normalized_visitors_by_region_naics_visits,</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="ss">    --uc.normalized_visitors_by_region_naics_visits uc_normalized_visitors_by_region_naics_visits</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="ss">  FROM</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="ss">    base sg</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="ss">  JOIN</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="ss">    `</span><span class="sc">{</span>UC_table<span class="sc">}</span><span class="ss">` uc</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="ss">  ON</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="ss">    sg.placekey = uc.placekey</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="ss">    AND DATE(sg.date_range_start) = DATE(uc.date_range_start)</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="ss">  WHERE</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="ss">    naics_code IN </span><span class="sc">{</span>industries<span class="sc">}</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="ss">    AND uc.date_range_start IS NOT NULL</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="ss">    AND sg.date_range_start IS NOT NULL ), </span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="ss">num_weeks_seen AS (</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="ss">  SELECT placekey, COUNT(DISTINCT date_range_start) as w_c FROM </span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="ss">  join_sg_uc</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="ss">  GROUP BY placekey HAVING w_c &gt; 7</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="ss">)</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="ss">SELECT </span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="ss">  join_sg_uc.*</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="ss">FROM join_sg_uc</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="ss">INNER JOIN num_weeks_seen USING(placekey) </span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-cellview="form">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title define functions</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_trimmed_metrics(df):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    We go through each column and for metrics we trim values low and above 1 quantile.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    This is applied on a per industry code basis and the resulting columns are "_trimmed"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> df.columns:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df[i].dtypes <span class="op">==</span> <span class="st">"Int64"</span> <span class="kw">or</span> df[i].dtypes <span class="op">==</span> <span class="st">"float64"</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      lb <span class="op">=</span> df.groupby(<span class="st">"naics_code"</span>)[i].quantile(<span class="fl">0.01</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      ub <span class="op">=</span> df.groupby(<span class="st">"naics_code"</span>)[i].quantile(<span class="fl">0.99</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      df <span class="op">=</span> df.join(lb, on<span class="op">=</span><span class="st">"naics_code"</span>, how<span class="op">=</span><span class="st">"left"</span>, rsuffix<span class="op">=</span><span class="st">"_lb"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      df <span class="op">=</span> df.join(ub, on<span class="op">=</span><span class="st">"naics_code"</span>, how<span class="op">=</span><span class="st">"left"</span>, rsuffix<span class="op">=</span><span class="st">"_ub"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      df[i <span class="op">+</span> <span class="st">"_trimmed"</span>]<span class="op">=</span> df[i][(df[i] <span class="op">&lt;</span> df[i <span class="op">+</span> <span class="st">"_ub"</span>]) <span class="op">&amp;</span> (df[i] <span class="op">&gt;</span> df[i <span class="op">+</span> <span class="st">"_lb"</span>])]</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      df.drop([i <span class="op">+</span> <span class="st">"_lb"</span>, i <span class="op">+</span> <span class="st">"_ub"</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_scatter(metric, df, time_inclusion <span class="op">=</span> <span class="va">False</span>, per_industry <span class="op">=</span> <span class="st">"ALL"</span>):</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Scatterplot using plotly express for selected metric with hardcoded hover_over.</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">    If time_inclusion = True, then each weeks data will appear in the plot. So to</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">    speak a regression including time.</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">    If per_industry is defining "brand" or "naics_code" those will be used for color coding</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">    and ensure separate processing per brand or naics_code. if "ALL" the is no split and everything goes in one.</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Otherwise it will calculate the mean across time.</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> per_industry <span class="op">!=</span> <span class="st">"ALL"</span>:</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> time_inclusion:</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      plot_data <span class="op">=</span> df.copy().groupby([<span class="st">"placekey"</span>, <span class="st">"date_range_start"</span>, <span class="st">"naics_code"</span>,<span class="st">"brands"</span>, <span class="st">"wkt_area_sq_meters"</span> ], as_index <span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      plot_data <span class="op">=</span> df.copy().groupby([<span class="st">"placekey"</span>, <span class="st">"naics_code"</span>, <span class="st">"brands"</span>, <span class="st">"wkt_area_sq_meters"</span>], as_index <span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.scatter(</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        plot_data, x<span class="op">=</span><span class="st">'uc_'</span> <span class="op">+</span> metric, y<span class="op">=</span><span class="st">'sg_'</span> <span class="op">+</span> metric, color<span class="op">=</span>per_industry, opacity<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        trendline<span class="op">=</span><span class="st">'ols'</span>, hover_data<span class="op">=</span>[<span class="st">"brands"</span>, <span class="st">"wkt_area_sq_meters"</span>], template<span class="op">=</span><span class="st">"unacast"</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> time_inclusion:</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      plot_data <span class="op">=</span> df.copy().groupby([<span class="st">"placekey"</span>, <span class="st">"date_range_start"</span>,<span class="st">"brands"</span>, <span class="st">"wkt_area_sq_meters"</span> ], as_index <span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      plot_data <span class="op">=</span> df.copy().groupby([<span class="st">"placekey"</span>, <span class="st">"brands"</span>, <span class="st">"wkt_area_sq_meters"</span>], as_index <span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.scatter(</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        plot_data, x<span class="op">=</span><span class="st">'uc_'</span> <span class="op">+</span> metric, y<span class="op">=</span><span class="st">'sg_'</span> <span class="op">+</span> metric, opacity<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        trendline<span class="op">=</span><span class="st">'ols'</span>, hover_data<span class="op">=</span>[<span class="st">"brands"</span>, <span class="st">"wkt_area_sq_meters"</span>], template<span class="op">=</span><span class="st">"unacast"</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  fig.show()</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_all_metrics(df):</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="co">    Get all unique metrics (int or float) from dataset</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  list_columns <span class="op">=</span> []</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> df.columns:</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df[i].dtypes <span class="op">==</span> <span class="st">"Int64"</span> <span class="kw">or</span> df[i].dtypes <span class="op">==</span> <span class="st">"float64"</span>:</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="st">"sg_"</span> <span class="kw">in</span> i <span class="kw">or</span> <span class="st">"uc_"</span> <span class="kw">in</span> i:</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        add_column <span class="op">=</span> i[<span class="dv">3</span>:]</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        add_column <span class="op">=</span> i</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> add_column <span class="kw">not</span> <span class="kw">in</span> list_columns:</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        list_columns.append(add_column) </span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>  list_columns.sort()</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> list_columns</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> widget_scatter_plot(dataset):</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co">      Create widgets for metrics and analysis type to quickly change plots. </span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="co">      I stole Malachy's code and adjusted it :-) </span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> widgets.Output()</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    dropdown_metric <span class="op">=</span> widgets.Dropdown(options <span class="op">=</span> get_all_metrics(dataset), </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>                                        value <span class="op">=</span> <span class="va">None</span>, description<span class="op">=</span><span class="st">'metrics:'</span>)</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    dropdown_type <span class="op">=</span> widgets.Dropdown(options <span class="op">=</span> [<span class="st">"place"</span>, <span class="st">"time"</span>], </span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>                                        value <span class="op">=</span> <span class="va">None</span>, description<span class="op">=</span><span class="st">'analysis type:'</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    dropdown_industry <span class="op">=</span> widgets.Dropdown(options <span class="op">=</span> [<span class="st">"ALL"</span>, <span class="st">"naics_code"</span>, <span class="st">"brands"</span>], </span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>                                        value <span class="op">=</span> <span class="va">None</span>, description<span class="op">=</span><span class="st">'per industry:'</span>)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> output_scatter(metric, analysis_type, industry):</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>            time_inclusion <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> analysis_type <span class="op">==</span> <span class="st">"time"</span>:</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>              time_inclusion <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            output_data <span class="op">=</span> plot_scatter(metric, dataset, time_inclusion, industry)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> output:</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>                display(output_data)</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>            IPython.display.clear_output(wait<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(e)</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>            display(input_widgets)</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dropdown_metric_eventhandler(change):</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>        display(input_widgets)</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>        dropdown_metric <span class="op">=</span> change.new</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>        output_scatter(metric <span class="op">=</span> dropdown_metric, </span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>                       analysis_type <span class="op">=</span> dropdown_type.value, </span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>                       industry <span class="op">=</span> dropdown_industry.value)</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>        IPython.display.clear_output(wait<span class="op">=</span><span class="va">True</span>)     </span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dropdown_type_eventhandler(change):</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>        display(input_widgets)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>        dropdown_type <span class="op">=</span> change.new</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>        output_scatter(metric <span class="op">=</span> dropdown_metric.value, </span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>                       analysis_type <span class="op">=</span> dropdown_type, </span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>                       industry <span class="op">=</span> dropdown_industry.value)</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>        IPython.display.clear_output(wait<span class="op">=</span><span class="va">True</span>)   </span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dropdown_industry_eventhandler(change):</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>        display(input_widgets)</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>        dropdown_industry <span class="op">=</span> change.new</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>        output_scatter(metric <span class="op">=</span> dropdown_metric.value, </span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>                       analysis_type <span class="op">=</span> dropdown_type.value, </span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>                       industry <span class="op">=</span> dropdown_industry)</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>        IPython.display.clear_output(wait<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>    dropdown_metric.observe(dropdown_metric_eventhandler, names<span class="op">=</span><span class="st">'value'</span>)</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>    dropdown_type.observe(dropdown_type_eventhandler, names<span class="op">=</span><span class="st">'value'</span>)</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>    dropdown_industry.observe(dropdown_industry_eventhandler, names<span class="op">=</span><span class="st">'value'</span>)</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>    input_widgets <span class="op">=</span> widgets.HBox([dropdown_industry, dropdown_type, dropdown_metric])</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>    display(input_widgets)</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>    IPython.display.clear_output(wait<span class="op">=</span><span class="va">True</span>)    </span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_metric_summary(df, split_column<span class="op">=</span><span class="st">"naics_code"</span>, top<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a><span class="co">   1. Get covariance matrix and fetch correlation coefficients per metric.</span></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a><span class="co">   2. create matrix with all correlations per placekey and split column</span></span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a><span class="co">   3. Bring in the percentage of places having &gt; .55 correlation.</span></span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a><span class="co">   4. calculate percentage drop in volume from SG to UC</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a><span class="co">  """</span></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>  correlation_summary <span class="op">=</span> pd.DataFrame()</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> top:</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>    top_split_column <span class="op">=</span> <span class="bu">list</span>(df.loc[df[split_column] <span class="op">!=</span> <span class="st">"NN"</span>].groupby(split_column).count().nlargest(top, <span class="st">"placekey"</span>).index)</span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.loc[df[split_column].isin(top_split_column)]</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> split_column:</span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> df.groupby(split_column).corr()</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> df.corr()</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>  list_columns <span class="op">=</span> get_all_metrics(df)</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>  list_columns.remove(<span class="st">"wkt_area_sq_meters"</span>)</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>  list_columns.remove(<span class="st">"wkt_area_sq_meters_trimmed"</span>)</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>  list_raw <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> list_columns <span class="cf">if</span> <span class="st">"_trimmed"</span> <span class="kw">not</span> <span class="kw">in</span> i]</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>  cov_matrix.reset_index(level<span class="op">=</span><span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"this is going to take a while since it runs correlations for all placekeys and naics codes..."</span>)</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>  temp_corr <span class="op">=</span> df.groupby([<span class="st">"placekey"</span>, split_column]).corr().reset_index(level<span class="op">=</span><span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> metric <span class="kw">in</span> list_raw:</span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>    temp_drop <span class="op">=</span> (df.groupby(split_column)[<span class="st">"sg_"</span> <span class="op">+</span> metric].mean() <span class="op">-</span> df.groupby(split_column)[<span class="st">"uc_"</span> <span class="op">+</span> metric].mean()) <span class="op">/</span> df.groupby(split_column)[<span class="st">"uc_"</span> <span class="op">+</span> metric].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>    temp_drop_trimmed <span class="op">=</span> (df.groupby(split_column)[<span class="st">"sg_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>].mean() <span class="op">-</span> df.groupby(split_column)[<span class="st">"uc_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>].mean()) <span class="op">/</span> df.groupby(split_column)[<span class="st">"uc_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n_code <span class="kw">in</span> cov_matrix[split_column].unique():</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>      correlation_summary <span class="op">=</span> correlation_summary.append({<span class="st">'metrics'</span>: metric, </span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>                    split_column: n_code, </span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># average correlation for raw and trimmed</span></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'avg_correlation_raw'</span>: cov_matrix[cov_matrix[split_column] <span class="op">==</span> n_code][<span class="st">"sg_"</span> <span class="op">+</span> metric][<span class="st">"uc_"</span> <span class="op">+</span> metric], </span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'avg_correlation_trimmed'</span>: cov_matrix[cov_matrix[split_column] <span class="op">==</span> n_code][<span class="st">"sg_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>][<span class="st">"uc_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>], </span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># get percentage of venues that are correlating &gt; .55. the temp_corr comes with all possible combinations and needs some long filtering.</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'percent_&gt;.55_raw'</span>: <span class="bu">round</span>(np.<span class="bu">sum</span>(temp_corr[(temp_corr[split_column] <span class="op">==</span> n_code) <span class="op">&amp;</span> (temp_corr[<span class="st">'level_1'</span>] <span class="op">==</span> <span class="st">"sg_"</span> <span class="op">+</span> metric)][<span class="st">"uc_"</span> <span class="op">+</span> metric] <span class="op">&gt;</span> <span class="fl">.55</span>) <span class="op">/</span> np.<span class="bu">sum</span>(temp_corr[(temp_corr[split_column] <span class="op">==</span> n_code) <span class="op">&amp;</span> (temp_corr[<span class="st">'level_1'</span>] <span class="op">==</span> <span class="st">"sg_"</span> <span class="op">+</span> metric)][<span class="st">"uc_"</span> <span class="op">+</span> metric] <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">1</span>), <span class="dv">2</span>) <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'percent_&gt;.55_trimmed'</span>: <span class="bu">round</span>(np.<span class="bu">sum</span>(temp_corr[(temp_corr[split_column] <span class="op">==</span> n_code) <span class="op">&amp;</span> (temp_corr[<span class="st">'level_1'</span>] <span class="op">==</span> <span class="st">"sg_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>)][<span class="st">"uc_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>] <span class="op">&gt;</span> <span class="fl">.55</span>) <span class="op">/</span> np.<span class="bu">sum</span>(temp_corr[(temp_corr[split_column] <span class="op">==</span> n_code) <span class="op">&amp;</span> (temp_corr[<span class="st">'level_1'</span>] <span class="op">==</span> <span class="st">"sg_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>)][<span class="st">"uc_"</span> <span class="op">+</span> metric <span class="op">+</span> <span class="st">"_trimmed"</span>] <span class="op">&gt;=</span> <span class="op">-</span><span class="dv">1</span>), <span class="dv">2</span>) <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># get mean percentage drop from SG to UC</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'percent_volume_drop_raw'</span>: <span class="bu">round</span>(np.nanmean(temp_drop[n_code])), </span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'percent_volume_drop_trimmed'</span>: <span class="bu">round</span>(np.nanmean(temp_drop_trimmed[n_code]))</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>                    }, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss"> is done!"</span>)</span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> correlation_summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-cellview="form">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title run queries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>query_job <span class="op">=</span> client.query(base_sql, job_config<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> query_job.to_dataframe()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#cast as float for some columns and add a trimmed version per industry</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'uc_distance_from_home'</span>] <span class="op">=</span> df[<span class="st">'uc_distance_from_home'</span>].astype(<span class="st">"float64"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'sg_distance_from_home'</span>] <span class="op">=</span> df[<span class="st">'sg_distance_from_home'</span>].astype(<span class="st">"float64"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> add_trimmed_metrics(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-cellview="form" data-outputid="9fba946e-995c-450e-ec07-368772961330">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title Widget</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>widget_scatter_plot(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="7981048a-e37f-470f-9240-623a68aa2951">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#@title get overall correlations of all metrics</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>grand_summary <span class="op">=</span> get_metric_summary(df, <span class="st">"naics_code"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>grand_summary.groupby([<span class="st">"metrics"</span>]).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>summary_by_naics_code <span class="op">=</span> get_metric_summary(df, <span class="st">"naics_code"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>summary_by_brand <span class="op">=</span> get_metric_summary(df, <span class="st">"brands"</span>, top<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>summary_by_region <span class="op">=</span> get_metric_summary(df, <span class="st">"region"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cartoframes.viz <span class="im">import</span> Map, Layer, color_continuous_style</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> metrics_per_group(summary, column, group, ndec<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    summary[column] <span class="op">=</span> summary[column].<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.<span class="bu">round</span>(x, ndec))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    op <span class="op">=</span> summary[[<span class="st">"metrics"</span>, group, column]].pivot(index<span class="op">=</span><span class="st">"metrics"</span>, columns<span class="op">=</span>group, values<span class="op">=</span>column)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    op.columns <span class="op">=</span> [re.sub(<span class="st">"[0-9]+_"</span>, <span class="st">""</span>, x) <span class="cf">for</span> x <span class="kw">in</span> op.columns]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    op <span class="op">=</span> op.reindex(<span class="bu">sorted</span>(op.columns), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> op</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_metrics_per_group(metrics_per_group, title):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.imshow(metrics_per_group, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                   text_auto<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                   title <span class="op">=</span> title,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                   template<span class="op">=</span><span class="st">"unacast"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        yaxis<span class="op">=</span>{<span class="st">'title'</span>: <span class="st">""</span>},</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        margin<span class="op">=</span>{<span class="st">"l"</span>: <span class="dv">80</span>, <span class="st">"r"</span>: <span class="dv">80</span>, <span class="st">"t"</span>: <span class="dv">100</span>, <span class="st">"b"</span>: <span class="dv">80</span>},</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_naics_code, <span class="st">"avg_correlation_trimmed"</span>, <span class="st">"naics_code"</span>), title<span class="op">=</span><span class="st">"Average correlation trimmed by Naics Code for metrics"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_naics_code, <span class="st">"percent_&gt;.55_trimmed"</span>, <span class="st">"naics_code"</span>), title<span class="op">=</span> <span class="st">"Percent of placekeys with above .55 correlation by Naics Code for metrics"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_naics_code, <span class="st">"percent_volume_drop_trimmed"</span>, <span class="st">"naics_code"</span>), title<span class="op">=</span><span class="st">"Percent volume drop trimmed by naics code for metrics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_brand, <span class="st">"avg_correlation_trimmed"</span>, <span class="st">"brands"</span>), title<span class="op">=</span><span class="st">"Average correlation trimmed by brand for metrics"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_brand, <span class="st">"percent_&gt;.55_trimmed"</span>, <span class="st">"brands"</span>), title<span class="op">=</span> <span class="st">"Percent of placekeys with above .55 correlation by brand for metrics"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_brand, <span class="st">"percent_volume_drop_trimmed"</span>, <span class="st">"brands"</span>), title<span class="op">=</span><span class="st">"Percent volume drop trimmed by brands for metrics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_region, <span class="st">"avg_correlation_trimmed"</span>, <span class="st">"region"</span>), title<span class="op">=</span><span class="st">"Average correlation trimmed by region for metrics"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_region, <span class="st">"percent_&gt;.55_trimmed"</span>, <span class="st">"region"</span>), title<span class="op">=</span> <span class="st">"Percent of placekeys with above .55 correlation by region for metrics"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>plot_metrics_per_group(metrics_per_group(summary_by_region, <span class="st">"percent_volume_drop_trimmed"</span>, <span class="st">"region"</span>), title<span class="op">=</span><span class="st">"Percent volume drop trimmed by region for metrics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>get_region_polygons <span class="op">=</span> client.query(<span class="st">"""</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT iso.Abbreviation as region, geog FROM `uc-atlas.maps_us.states_iso` iso</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN `uc-atlas.maps_us.states` pol ON iso.State = pol.state_name</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>).to_dataframe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> metric_by_region_map(summary, region_poly, column):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    maps <span class="op">=</span> {}</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    geog_df <span class="op">=</span> summary.merge(region_poly, on<span class="op">=</span><span class="st">"region"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, grp <span class="kw">in</span> geog_df.groupby(<span class="st">"metrics"</span>):</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        maps[k] <span class="op">=</span> Map([</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                    Layer(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                        grp, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                        geom_col<span class="op">=</span><span class="st">"geog"</span>, </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                        style<span class="op">=</span>color_continuous_style(value<span class="op">=</span>column),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                        title <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>column<span class="sc">}</span><span class="ss"> for metric </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> maps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>metric_by_region <span class="op">=</span> metric_by_region_map(summary_by_region, get_region_polygons, <span class="st">"avg_correlation_trimmed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>metric_by_region[<span class="st">"raw_visit_counts"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_code <span class="kw">in</span> grand_summary[<span class="st">"naics_code"</span>].unique():</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="op">=</span> grand_summary[grand_summary[<span class="st">"naics_code"</span>] <span class="op">==</span> n_code].drop(<span class="st">"naics_code"</span>, axis<span class="op">=</span><span class="dv">1</span>).set_index(<span class="st">'metrics'</span>).transpose().stack().reset_index(level<span class="op">=</span><span class="dv">0</span>).copy()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  df_plot.reset_index(level<span class="op">=</span><span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  df_plot.columns <span class="op">=</span> [<span class="st">"metrics"</span>, <span class="st">"features"</span>, <span class="st">"values"</span>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  fig <span class="op">=</span> px.line_polar(df_plot, r<span class="op">=</span><span class="st">"values"</span>, theta<span class="op">=</span><span class="st">"features"</span>, color<span class="op">=</span><span class="st">"metrics"</span>, line_close<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                    template<span class="op">=</span><span class="st">"unacast"</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#grand_summary.reset_index(level=0, inplace=True)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#grand_summary.columns = ["metrics", "avg_corr_raw", "avg_corr_trim", "%_&gt;.55_raw", "%_&gt;.55_trim", "%_vol_drop_raw", "%_vol_drop_trim"]</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> grand_summary.set_index(<span class="st">'metrics'</span>).transpose().stack().reset_index(level<span class="op">=</span><span class="dv">0</span>).copy()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>df_test.reset_index(level<span class="op">=</span><span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>df_test.columns <span class="op">=</span> [<span class="st">"metrics"</span>, <span class="st">"features"</span>, <span class="st">"values"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>